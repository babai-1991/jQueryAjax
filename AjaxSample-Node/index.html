<!DOCTYPE html>
<html>

<head>
  <title>Ajax Samples</title>

  <link rel="stylesheet" type="text/css" href="/styles/site.css">
</head>

<body>
  <h1>Ajax Samples</h1>
  <p>Bring up console window</p>

  <form>
    <div class="row">
      <label for="productID">Product ID</label>
      <input id="productID" name="productID" type="text" value="0" />
    </div>
    <div class="row">
      <label for="name">Product Name</label>
      <input id="name" name="name" type="text" value="A New Product" />
    </div>
    <div class="row">
      <label for="productNumber">Product Number</label>
      <input id="productNumber" name="productNumber" type="text" value="NEW-999" />
    </div>
    <div class="row">
      <label for="color">Color</label>
      <input id="color" name="color" type="text" value="Red" />
    </div>
    <div class="row">
      <label for="standardCost">Cost</label>
      <input id="standardCost" name="standardCost" type="number" value="10.00" />
    </div>
    <div class="row">
      <label for="listPrice">Price</label>
      <input id="listPrice" name="listPrice" type="number" value="25.00" />
    </div>
    <div class="row">
      <label for="sellStartDate">Sell Start Date</label>
      <input id="sellStartDate" name="sellStartDate" type="text" value="1/15/2021" />
    </div>
    <div class="row">
      <label id="message" class="infoMessage"></label>
      <label id="error" class="errorMessage"></label>
    </div>
    <div class="row">
      <button type="button" onclick="get();">
        Get Products
      </button>
      <button type="button" onclick="getProduct();">
        Get a Product
      </button>
      <button type="button" onclick="insertProduct();">
        Insert Product
      </button>
      <button type="button" onclick="updateProduct();">
        Update Product
      </button>
      <button type="button" onclick="deleteProduct();">
        Delete Product
      </button>
    </div>
  </form>

  <script src="/scripts/ajax-common.js"></script>
  <script src="/scripts/product.js"></script>
  <script>
    'use strict';

    const URL = "https://localhost:44330/api/product";

    let _lastStatus = {
      "status": 0,
      "statusText": "",
      "ok": false
    };

    function displayAllData(resp) {
      if (_lastStatus.ok) {
        console.log("In displayAllData()");
        for (let i = 0; i < 10; i++) {
          console.log(resp[i]);
        }
      }
    }

    function displayResponse(resp) {
      console.log("In displayResponse()");
      console.log(resp);
    }

    function processResponse(resp) {
      console.log("In processResponse()");

      // Copy status info to _lastStatus property
      _lastStatus.status = resp.status;
      _lastStatus.statusText = resp.statusText;
      _lastStatus.ok = resp.ok;

      // Display the status object
      console.log(_lastStatus);

      if (_lastStatus.ok) {
        // Return the json from the response object to pass to the next .then() method
        return resp.json();
      }
      else {
        return null;
        // Uncomment the following if you wish to go into the .catch() method
        // return Promise.reject(resp);
      }
    }

    function get() {
      // The data returned is an array of product objects
      fetch(URL)
        .then(response => processResponse(response))
        .then(data => {
          if (_lastStatus.ok) {
            displayMessage("Products Retrieved");
            displayAllData(data);
          }
          else {
            displayError(_lastStatus.statusText);
          }
        })
        .catch(error => handleAjaxError(error));
    }

    function getProduct() {
      // Retrieve a single product
      fetch(URL + "/" + getValue("productID"))
        .then(response => processResponse(response))
        .then(data => {
          if (_lastStatus.ok) {
            displayMessage("Product Retrieved");
            setInput(data);
          }
          else {
            displayError(_lastStatus.statusText);
          }
        })
        .catch(error => handleAjaxError(error));
    }

    const insertProduct = () => {
      //gather data from user input
      let product = getFromInput();

      let options = {
        method: 'POST',
        headers: {
          'content-type': 'application/json'
        },
        body: JSON.stringify(product)
      }

      fetch(URL, options).then((onSuccessResult) => {
        return onSuccessResult.json();
      }).then((data) => {
        console.log(data);
        //display product
        setInput(data);
      }).catch((error) => {
        handleAjaxError(error);
      })
    }

    function updateProduct() {
      // Gather data from user input
      let product = getFromInput();

      let options = {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(product)
      };

      fetch(URL + "/" + product.productID, options)
        .then(response => processResponse(response))
        .then(data => {
          if (_lastStatus.ok) {
            displayMessage("Product Updated");
            displayResponse(data);
            // Display Product Info
            setInput(data);
          }
          else {
            displayError(_lastStatus.statusText);
          }
        })
        .catch(error => handleAjaxError(error));
    }

    function deleteProduct() {
      // Gather data from user input
      let product = getFromInput();

      let options = {
        method: 'DELETE'
      };

      fetch(URL + "/" + product.productID, options)
        .then(response => processResponse(response))
        .then(data => {
          if (_lastStatus.ok) {
            displayMessage("Product Deleted");
            displayResponse(data);
            // Clear Product Info
            clearInput();
          }
          else {
            displayError(_lastStatus.statusText);
          }
        })
        .catch(error => handleAjaxError(error));
    }
  </script>
</body>

</html>